{% extends "base.html" %}
{% block content %}

<div class="card">
  <div class="top">
    <strong>Teacher Dashboard</strong>
    <span class="pill">Auto refresh: <span id="sec">15</span>s</span>
  </div>

  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
    <span class="pill">Total registered: <strong>{{ total_users }}</strong></span>
    <span class="pill">Total activities: <strong>{{ total }}</strong></span>
  </div>

  <div style="height:12px"></div>
  <input id="q" placeholder="Search name or email" oninput="filterRows()" />
</div>

<div class="card" style="margin-top:14px;">
  <ul id="list">
    {% for r in rows %}
      <li data-text="{{ (r['name'] ~ ' ' ~ r['email'])|lower }}">
        <strong>{{ r["name"] }}</strong><br>
        <span class="muted">{{ r["email"] }}</span><br>
        <span class="pill">{{ r["cnt"] }} / {{ total }}</span>
      </li>
    {% else %}
      <li class="muted">No students yet.</li>
    {% endfor %}
  </ul>
</div>

<script>
  function filterRows() {
    const q = (document.getElementById("q").value || "").toLowerCase().trim();
    const items = document.querySelectorAll("#list li[data-text]");
    items.forEach(li => {
      const t = li.getAttribute("data-text") || "";
      li.style.display = t.includes(q) ? "" : "none";
    });
  }

  (function startAutoRefresh(){
    if (window.__autoRefreshStarted) return;
    window.__autoRefreshStarted = true;

    let remaining = 15;
    const secEl = document.getElementById("sec");
    secEl.textContent = String(remaining);

    setInterval(() => {
      remaining -= 1;
      if (remaining <= 0) {
        secEl.textContent = "0";
      } else {
        secEl.textContent = String(remaining);
      }
    }, 1000);

    setTimeout(() => {
      window.location.replace(window.location.href);
    }, 15000);
  })();
</script>

{% endblock %}
